# CMakeé…ç½®ç”¨äºç¼–è¯‘å¤šæ™ºèƒ½ä½“Pythonç»‘å®š
cmake_minimum_required(VERSION 3.16)
project(MultiAgentGoBigger)

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# æŸ¥æ‰¾Pythonå’Œpybind11
find_package(Python COMPONENTS Interpreter Development REQUIRED)

# æŸ¥æ‰¾pybind11
find_package(pybind11 QUIET)
if(NOT pybind11_FOUND)
    # å¦‚æœç³»ç»Ÿæ²¡æœ‰pybind11ï¼Œå°è¯•ä½¿ç”¨pipå®‰è£…çš„ç‰ˆæœ¬
    execute_process(
        COMMAND ${Python_EXECUTABLE} -m pybind11 --cmake
        OUTPUT_VARIABLE pybind11_DIR
        OUTPUT_STRIP_TRAILING_WHITESPACE
    )
    if(pybind11_DIR)
        find_package(pybind11 REQUIRED HINTS ${pybind11_DIR})
    else()
        message(FATAL_ERROR "pybind11 not found. Please install: pip install pybind11")
    endif()
endif()

# è®¾ç½®Qtè·¯å¾„
set(CMAKE_PREFIX_PATH "D:/qt/6.9.1/msvc2022_64" CACHE PATH "Qt installation path")
find_package(Qt6 REQUIRED COMPONENTS Core Widgets)

# å¯ç”¨Qt MOC
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC ON)

# å¤šæ™ºèƒ½ä½“æ¨¡å—æºæ–‡ä»¶
set(MULTI_AGENT_SOURCES
    ../python/multi_agent_game_engine.cpp
    ../python/multi_agent_bindings.cpp
    
    # src_newä¸­çš„æ ¸å¿ƒæ–‡ä»¶
    ../src_new/GameManager.cpp
    ../src_new/MultiPlayerManager.cpp
    ../src_new/SimpleAIPlayer.cpp
    ../src_new/CloneBall.cpp
    ../src_new/BaseBall.cpp
    ../src_new/FoodBall.cpp
    ../src_new/SporeBall.cpp
    ../src_new/ThornsBall.cpp
    ../src_new/QuadTree.cpp
    ../src_new/PlayerCell.cpp
    ../src_new/ONNXInference.cpp
)

# å¤šæ™ºèƒ½ä½“æ¨¡å—å¤´æ–‡ä»¶
set(MULTI_AGENT_HEADERS
    ../python/multi_agent_game_engine.h
    ../python/pybind11_qt_casters.h
    
    # src_newä¸­çš„å¤´æ–‡ä»¶
    ../src_new/GameManager.h
    ../src_new/MultiPlayerManager.h
    ../src_new/SimpleAIPlayer.h
    ../src_new/CloneBall.h
    ../src_new/BaseBall.h
    ../src_new/FoodBall.h
    ../src_new/SporeBall.h
    ../src_new/ThornsBall.h
    ../src_new/QuadTree.h
    ../src_new/PlayerCell.h
    ../src_new/ONNXInference.h
    ../src_new/GoBiggerConfig.h
)

# åˆ›å»ºå¤šæ™ºèƒ½ä½“Pythonæ¨¡å—
pybind11_add_module(gobigger_multi_env ${MULTI_AGENT_SOURCES} ${MULTI_AGENT_HEADERS})

# è®¾ç½®ç¼–è¯‘å±æ€§
target_compile_definitions(gobigger_multi_env PRIVATE VERSION_INFO=${EXAMPLE_VERSION_INFO})
target_compile_features(gobigger_multi_env PRIVATE cxx_std_17)

# é“¾æ¥Qtåº“
target_link_libraries(gobigger_multi_env PRIVATE Qt6::Core Qt6::Widgets)

# è®¾ç½®åŒ…å«ç›®å½•
target_include_directories(gobigger_multi_env PRIVATE 
    ../src_new
    ../python
)

# è®¾ç½®è¾“å‡ºç›®å½•
set_target_properties(gobigger_multi_env PROPERTIES
    LIBRARY_OUTPUT_DIRECTORY ../python
    LIBRARY_OUTPUT_DIRECTORY_DEBUG ../python
    LIBRARY_OUTPUT_DIRECTORY_RELEASE ../python
)

# Windowsç‰¹å®šè®¾ç½®
if(WIN32)
    set_target_properties(gobigger_multi_env PROPERTIES
        SUFFIX ".pyd"
        LIBRARY_OUTPUT_NAME "gobigger_multi_env"
    )
endif()

# ç¼–è¯‘å™¨ç‰¹å®šè®¾ç½®
if(MSVC)
    target_compile_options(gobigger_multi_env PRIVATE /W4)
else()
    target_compile_options(gobigger_multi_env PRIVATE -Wall -Wextra -pedantic)
endif()

# è‡ªåŠ¨å¤åˆ¶Qt DLLåˆ°è¾“å‡ºç›®å½•ï¼ˆWindowsï¼‰
if(WIN32)
    add_custom_command(TARGET gobigger_multi_env POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        $<TARGET_FILE:Qt6::Core>
        ../python/
        
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        $<TARGET_FILE:Qt6::Widgets>
        ../python/
        
        COMMENT "Copying Qt DLLs to python directory"
    )
endif()

message(STATUS "ğŸ¤– å¤šæ™ºèƒ½ä½“Pythonç»‘å®šé…ç½®å®Œæˆ")
message(STATUS "   æ¨¡å—å: gobigger_multi_env")
message(STATUS "   è¾“å‡ºç›®å½•: ../python")
message(STATUS "   æºæ–‡ä»¶æ•°: 16")
